---
æ ‡é¢˜: 5.deferã€recoverå¼‚å¸¸æ•è·å’Œå¤„ç†
åˆ›å»ºæ—¶é—´: 2023-03-28 17:37
ä¿®æ”¹æ—¶é—´: 2023-03-29 10:59
tags: 
---


# ğŸ¥deferçš„åº”ç”¨åœºæ™¯
## 1. èµ„æºé‡Šæ”¾
> å…³é—­æ–‡ä»¶ã€å…³é—­è¿æ¥ç­‰
## 2. å¼‚å¸¸æ•è·å’Œå¤„ç†

# ğŸ•¤defer
>1. deferå…³é”®å­—ç”¨æ¥å£°æ˜ä¸€ä¸ªå»¶è¿Ÿè°ƒç”¨çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°å¯ä»¥ä½¿åŒ¿åå‡½æ•°ä¹Ÿå¯ä»¥æ˜¯å…·åå‡½æ•°ã€‚
>2. deferå»¶è¿Ÿå‡½æ•°æ‰§è¡Œæ—¶æœºï¼Œæ–¹æ³•returnä¹‹åï¼Œè¿”å›å‚æ•°åˆ°è°ƒç”¨æ–¹æ³•ä¹‹å‰ã€‚
>3. deferå»¶è¿Ÿå‡½æ•°å¯ä»¥åœ¨æ–¹æ³•è¿”å›å€¼åæ”¹å˜å‡½æ•°çš„è¿”å›å€¼ã€‚
>4. åœ¨æ–¹æ³•ç»“æŸï¼ˆæ­£å¸¸è¿”å›ï¼Œå¼‚å¸¸ç»“æŸï¼‰åï¼Œéƒ½ä¼šè°ƒç”¨deferå£°æ˜çš„å»¶è¿Ÿå‡½æ•°ï¼Œå¯ä»¥æœ‰æ•ˆé¿å…å› å¼‚å¸¸å¯¼è‡´çš„èµ„æºæ— æ³•é‡Šæ”¾çš„é—®é¢˜ã€‚
>5. å¯ä»¥æŒ‡å®šå¤šä¸ªdeferå»¶è¿Ÿå‡½æ•°ï¼Œå¤šä¸ªå‡½æ•°æ‰§è¡Œé¡ºåºä¸ºåè¿›å…ˆå‡ºã€‚
>6. deferä¸recoveré…åˆå¯ä»¥å®ç°å¼‚å¸¸æ•è·ä¸å¤„ç†é€»è¾‘ã€‚
>7. ä¸å»ºè®®åœ¨forå¾ªç¯ä¸­ä½¿ç”¨defer

# ğŸ‘“recover
>1. Goè¯­è¨€çš„å†…å»ºå‡½æ•°ï¼Œå¯ä»¥è®©è¿›å…¥å®•æœºæµç¨‹ä¸­çš„goroutineæ¢å¤è¿‡æ¥ã€‚
>2. recoverä»…åœ¨å»¶è¿Ÿå‡½æ•°deferä¸­æœ‰æ•ˆï¼Œåœ¨æ­£å¸¸æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨recoverä¼šè¿”å›nilå¹¶æ²¡æœ‰å…¶ä»–ä»»ä½•æ•ˆæœã€‚
>3. å¦‚æœå½“å‰çš„goroutineå‡ºç°panicï¼Œè°ƒç”¨recoverå¯ä»¥æ•è·åˆ°panicçš„è¾“å…¥å€¼ï¼Œå¹¶æ¢å¤æ­£å¸¸çš„æ‰§è¡Œã€‚

# ğŸš¨panic
>1. Goè¯­è¨€çš„ä¸€ç§å¼‚å¸¸æœºåˆ¶ã€‚
>2. å¯ä»¥é€šè¿‡panicå‡½æ•°ä¸»åŠ¨æŠ›å‡ºå¼‚å¸¸

```go
func f1() {
	println("in defer function2")
}

func deferCase1() {
	println("start defer case 1")

	defer func() {
		println("in defer function1")
	}()
	defer f1()
	println("defer case end")
}
```
æ‰§è¡Œç»“æœå¦‚ä¸‹:
```sh
start defer case 1
defer case end
in defer function2
in defer function1
```

```go
//å‚æ•°é¢„è®¡ç®—
func deferCase2(){
  i := 1 
  //ä¼ å‚
  defer func(j int){
    println("defer j:",j)
  }(i+1)
  //é—­åŒ…
  defer func(){
    println("defer j:",i)
  }()
  i = 99
  println("i: ",i)
}
```
è¿è¡Œç»“æœå¦‚ä¸‹:
```sh
i:  99
defer j: 99
defer j: 2
```

```go
//è¿”å›å€¼ï¼Œdeferæ‰§è¡Œåœ¨returunä¹‹å
var g = 100
func f2()(int,*int){
  defer func(){
    g = 200
  }()
  println("f2 g: ",g)
  return g,&g
}

func deferCase3(){
  i,j := f2()
  println("i,j,g: ",i,*j,g)
}
```
è¿è¡Œç»“æœå¦‚ä¸‹:
```sh
f2 g:  100
i,j,g:  100 200 200
```

ä½¿ç”¨deferå’Œrecoverè¿›è¡Œå¼‚å¸¸å¤„ç†
```go
func exceptionCase(){
  defer func(){
    err := recover()
    if err != nil{
      println("error dealing...  defer recover:",err)
    }
  }()
  println("start exceptionCase")
  panic("exceptionCase error")
  println("end exceptionCase")
}
```
è¿è¡Œç»“æœ:
```sh
start exceptionCase
error dealing...  defer recover: (0x45d6a0,0x47c610)
```
